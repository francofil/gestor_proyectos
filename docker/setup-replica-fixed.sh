#!/bin/bashset -eecho "===== INICIANDO CONFIGURACI??N DE REPLICA ====="# Esperar a que el master est?? completamente listoecho "Esperando al master..."until pg_isready -h db-master -p 5432 -U "$POSTGRES_USER"; do  echo "Master a??n no est?? listo, esperando..."  sleep 3doneecho "Master est?? listo. Esperando 5 segundos adicionales..."sleep 5# Detener PostgreSQL si est?? corriendoecho "Deteniendo PostgreSQL temporal..."pg_ctl -D "$PGDATA" stop -m fast || truesleep 2# Limpiar el directorio de datosecho "Limpiando directorio de datos..."rm -rf "$PGDATA"/*# Realizar backup base desde el masterecho "Realizando pg_basebackup desde master..."PGPASSWORD="$POSTGRES_PASSWORD" pg_basebackup -h db-master -p 5432 -D "$PGDATA" -U replicator -v -P -R --checkpoint=fast# Verificar que se cre?? correctamenteif [ ! -f "$PGDATA/postgresql.conf" ]; then  echo "ERROR: pg_basebackup fall??"  exit 1fiecho "pg_basebackup completado exitosamente"# Configurar modo de solo lectura en postgresql.confecho "Configurando modo de solo lectura..."cat >> "$PGDATA/postgresql.conf" << EOF# ==== CONFIGURACI??N DE REPLICA ====default_transaction_read_only = onhot_standby = onlog_statement = alllog_destination = stderrlogging_collector = offEOFecho "===== REPLICA CONFIGURADA CORRECTAMENTE ====="
